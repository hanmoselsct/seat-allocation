<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>è€å¸ˆåå°</title>
<link rel="stylesheet" href="/static/style.css">
<style>
table { width:100%; border-collapse:collapse; }
th,td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#1e6fba; color:white; }
tr:nth-child(even){ background:#f9f9f9; }
#seatMapModal {
  position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6); display:none;
  align-items:center; justify-content:center; z-index:999;
}
#seatMapModal img { max-width:90%; max-height:85%; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.4);}
#seatMapModal .close-btn {
  position:absolute; top:20px; right:30px; background:#fff; color:#000;
  border:none; border-radius:6px; padding:8px 12px; cursor:pointer; font-weight:bold;
}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ‘©â€ğŸ« è€å¸ˆåå°</h1>

  <div class="card" id="loginBox">
    <h3>è¯·è¾“å…¥è€å¸ˆå¯†ç </h3>
    <input id="teacherPwd" type="password">
    <button onclick="login()">ç™»å½•</button>
  </div>

  <div id="mainBox" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2>å­¦ç”Ÿå¿—æ„¿åˆ—è¡¨</h2>
      <div>
        <button onclick="refresh()">åˆ·æ–°æ•°æ®</button>
        <button onclick="assign()">å¼€å§‹åˆ†é…</button>
        <button onclick="viewSeatMap()">æŸ¥çœ‹å½•å–åº§ä½å›¾</button>
        <button style="background:#dc3545" onclick="resetAll()">æ¸…ç©ºæ•°æ®</button>
      </div>
    </div>
    <table id="studentTable">
      <thead><tr><th>å§“å</th><th>æˆç»©</th><th>å¿—æ„¿</th><th>å½•å–ç»“æœ</th></tr></thead>
      <tbody><tr><td colspan="4">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»â€œåˆ·æ–°æ•°æ®â€</td></tr></tbody>
    </table>
  </div>
</div>

<div id="seatMapModal">
  <button class="close-btn" onclick="hideSeatMap()">Ã— å…³é—­</button>
  <img id="seatMapImage" src="">
</div>

<script>
function login(){
  const pwd=document.getElementById("teacherPwd").value;
  fetch("/api/teacher_login",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({password:pwd})}).then(r=>r.json()).then(d=>{
    if(d.ok){
      document.getElementById("loginBox").style.display="none";
      document.getElementById("mainBox").style.display="block";
    } else alert("å¯†ç é”™è¯¯");
  });
}

function refresh(){
  fetch("/api/students",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({teacher_password:document.getElementById("teacherPwd").value})})
  .then(r=>r.json()).then(d=>{
    const tbody=document.querySelector("#studentTable tbody");
    tbody.innerHTML="";
    if(!d.students.length){
      tbody.innerHTML="<tr><td colspan='4'>æš‚æ— å­¦ç”Ÿæ•°æ®</td></tr>";
      return;
    }
    d.students.forEach(s=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${s.name}</td><td>${s.score}</td>
        <td>${s.volunteers.join("ã€")}</td><td>${s.admitted||""}</td>`;
      tbody.appendChild(tr);
    });
  });
}

function assign(){
  fetch("/api/assign",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({teacher_password:document.getElementById("teacherPwd").value})})
  .then(r=>r.json()).then(d=>{ if(d.ok){ alert("åˆ†é…å®Œæˆ"); refresh(); }});
}

function viewSeatMap(){
  const modal=document.getElementById("seatMapModal");
  const img=document.getElementById("seatMapImage");
  img.src="/seatmap.png?t="+Date.now();
  modal.style.display="flex";
}
function hideSeatMap(){ document.getElementById("seatMapModal").style.display="none"; }

function resetAll(){
  if(!confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ"))return;
  fetch("/api/reset",{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({teacher_password:document.getElementById("teacherPwd").value})})
  .then(()=>{alert("å·²æ¸…ç©º");refresh();});
}
</script>
</body>
</html>
